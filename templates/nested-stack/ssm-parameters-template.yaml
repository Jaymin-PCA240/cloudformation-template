AWSTemplateFormatVersion: "2010-09-09"
Description: "Nested stack for SSM Parameters (CloudWatch agent config + DB secret reference)"

Parameters:
  MyDatabaseSecretArn:
    Type: String
    Description: "ARN of RDS DB secret from Secrets Manager"

Resources:

  CloudWatchAgentConfig:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /ec2/cloudwatch/agent/config
      Type: String
      Value: !Sub |
        {
          "logs": {
            "logs_collected": {
              "files": {
                "collect_list": [
                  {
                    "file_path": "/home/ec2-user/app/logs/*.log",
                    "log_group_name": "/ec2/backend/logs",
                    "log_stream_name": "{instance_id}/backend",
                    "timezone": "UTC"
                  },
                  {
                    "file_path": "/var/log/messages",
                    "log_group_name": "/ec2/application/logs",
                    "log_stream_name": "{instance_id}/system",
                    "timezone": "UTC"
                  },
                  {
                    "file_path": "/home/ec2-user/.pm2/logs/*.log",
                    "log_group_name": "/ec2/pm2/logs",
                    "log_stream_name": "{instance_id}/pm2",
                    "timezone": "UTC"
                  }
                ]
              }
            },
            "log_stream_name": "ec2-{instance_id}",
            "force_flush_interval": 15
          }
        }

Outputs:
  CloudWatchAgentConfigParam:
    Value: !Ref CloudWatchAgentConfig
    Export:
      Name: !Sub "${AWS::StackName}-CloudWatchAgentConfig"
