AWSTemplateFormatVersion: "2010-09-09"
Description: "Nested Stack — Standard MySQL"

Parameters:
  VpcId:
    Type: String
  SubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
  DatabaseName:
    Type: String
    Default: tododb
  DBSecurityGroup:
    Type: String
  BackendDbSecret:
    Type: String
  AppName:                     
    Type: String
  Environment:                  
    Type: String

Resources:

  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: "Aurora Subnet Group"
      SubnetIds: !Ref SubnetIds
      DBSubnetGroupName:       
        !Sub "${AppName}-${Environment}-db-subnetgroup"
      Tags:                  
        - Key: Name
          Value: !Sub "${AppName}-${Environment}-db-subnetgroup"
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Ref AppName

  MySQLInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: 
        !Sub "${AppName}-${Environment}-db-rds"
      Engine: mysql # ⚡ Change: Use standard MySQL
      EngineVersion: "8.0.42" # Optional: MySQL version
      DBInstanceClass: db.t3.micro
      MasterUsername: !Join 
        - ''
        - ['{{resolve:secretsmanager:', !Ref BackendDbSecret, ':SecretString:username}}']
      MasterUserPassword: !Join
        - ''
        - ['{{resolve:secretsmanager:', !Ref BackendDbSecret, ':SecretString:password}}']
      AllocatedStorage: 20 # Storage in GB
      DBSubnetGroupName: !Ref DBSubnetGroup
      DBName: !Ref DatabaseName
      VPCSecurityGroups:
        - !Ref DBSecurityGroup
      PubliclyAccessible: false
      StorageEncrypted: true
      BackupRetentionPeriod: 7
      DeletionProtection: false
      Tags:                
        - Key: Name
          Value: !Sub "${AppName}-${Environment}-db-rds"
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Ref AppName

Outputs:
  DBEndpoint:
    Value: !GetAtt MySQLInstance.Endpoint.Address
    Export:
      Name: MySQLEndpoint
