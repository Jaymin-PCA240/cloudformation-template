AWSTemplateFormatVersion: "2010-09-09"
Description: "Nested Stack â€” Aurora MySQL Cluster"

Parameters:
  VpcId:
    Type: String
  SubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
  DatabaseName:
    Type: String
    Default: tododb
  DBSecurityGroup:
    Type: String
  BackendDbSecret:
    Type: String
  AppName:                      
    Type: String
  Environment:                  
    Type: String


Resources:
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: "Aurora Subnet Group"
      DBSubnetGroupName: !Sub "${AppName}-${Environment}-db-subnetgroup" 
      SubnetIds: !Ref SubnetIds
      Tags:                                                        
        - Key: Name
          Value: !Sub "${AppName}-${Environment}-db-subnetgroup"
        - Key: Application
          Value: !Ref AppName
        - Key: Environment
          Value: !Ref Environment

  AuroraCluster:
    Type: AWS::RDS::DBCluster
    Properties:
      Engine: aurora-mysql
      EngineVersion: "8.0.mysql_aurora.3.05.2"
      DBClusterIdentifier: !Sub "${AppName}-${Environment}-db-cluster"
      DBClusterIdentifier: my-aurora-cluster
      MasterUsername: !Join 
        - ''
        - ['{{resolve:secretsmanager:', !Ref BackendDbSecret, ':SecretString:username}}']
      MasterUserPassword: !Join
        - ''
        - ['{{resolve:secretsmanager:', !Ref BackendDbSecret, ':SecretString:password}}']
      DBSubnetGroupName: !Ref DBSubnetGroup
      DatabaseName: !Ref DatabaseName
      VpcSecurityGroupIds:
        - !Ref DBSecurityGroup
      StorageEncrypted: true
      BackupRetentionPeriod: 7
      DeletionProtection: false
      Tags:                                                        
        - Key: Name
          Value: !Sub "${AppName}-${Environment}-db-cluster"
        - Key: Application
          Value: !Ref AppName
        - Key: Environment
          Value: !Ref Environment

  AuroraInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      DBClusterIdentifier: !Ref AuroraCluster
      DBInstanceClass: db.t3.medium
      Engine: aurora-mysql
      PubliclyAccessible: false
      DBInstanceIdentifier: !Sub "${AppName}-${Environment}-db-instance" 
      Tags:                                                        
        - Key: Name
          Value: !Sub "${AppName}-${Environment}-db-instance"
        - Key: Application
          Value: !Ref AppName
        - Key: Environment
          Value: !Ref Environment

Outputs:
  DBEndpoint:
    Value: !GetAtt AuroraCluster.Endpoint.Address
    Export:
      Name: AuroraEndpoint
